!function(){"use strict";class e{constructor(e){this.server=e}async add(e){const t=await fetch(this.server,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t;return await s.json()}}class t{constructor(){this.urlRegex=/(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi,this.codeRegex=/(\`{3}(\n?(.*)\n?[^`]+)\`{3})/gi}checkLink(e){return null!==e.match(this.urlRegex)}checkCode(e){return null!==e.match(this.codeRegex)}addLink(e){return e.replace(this.urlRegex,(e=>`<a href="${e}">${e}</a>`))}addCode(e){return e.replace(this.codeRegex,(e=>`<code class="code"><br>${e.match(/[^\n]+/g).join("<br>").replace(/```/gi,"")}</code>`))}}function s(e,s,i){const o=document.querySelector(".chat"),n=o.querySelectorAll(".message"),a=document.querySelector(".emoji__container");let r="connection";const c=new t;let l=null;switch(a.classList.contains("d__none")||a.classList.add("d__none"),n.length>=10&&"send"==s&&o.firstElementChild.remove(),document.querySelector(".files__box").classList.contains("d__none")||document.querySelector(".files__box").classList.add("d__none"),void 0!==e.name&&e.name===i&&(e.name="you",r="connection__you"),e.typesms){case"text":l=`<p class="message__text">${e.text}</p>`;break;case"link":l=`<div class="message__text">${c.addLink(e.text)}</div>`;break;case"code":l=`<div class="message__text">${c.addCode(e.text)}</div>`;break;case"file":l=` <div class="file__info">\n                      <div class="file__img"></div>\n                      <div class="message__info_file">\n                        <a class="message__name" href="${e.url}" rel="noopener" download="${e.fileName}">${e.fileName}</a>\n                        <div class="message__size">${function(e){let t=0,s=parseInt(e,10)||0;for(;s>=1024&&++t;)s/=1024;return`${s.toFixed(s<10&&t>0?1:0)} ${["bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][t]}`}(e.fileSize)}</div>\n                      </div>\n                    </div>`;break;case"image":l=`<img class="preview__image" src="${e.url}" alt="альтернативный текст">`;break;case"audio":l=`\n                      <audio class="audio" src="${e.url}" controls muted>\n                     </audio>`;break;case"video":l=` \n                    <video class="video__message" src="${e.url}" controls muted preload="metadata" width="200"  height="200px">\n                    </video>`;break;default:l=""}const d=` <div class="message message__${e.typesms} ${r}" data-id="${e.dataId}">\n                    <div class="message__info ">\n                      <div class="message__user__name">${e.name} </div>\n                      <div class="message__time">${e.datatime} </div>\n                    </div>\n                    ${l}\n                  </div>\n  `;void 0!==d&&"send"==s&&(o.insertAdjacentHTML("beforeend",d),o.lastElementChild.scrollIntoView(!1)),void 0!==d&&"allsms"==s&&o.insertAdjacentHTML("afterbegin",d)}var i={text:"Что-то пошло не так",discrition:"К сожалению нам не удалось определить ваше местоположение. Пожалуйста дайте согласие на использование геолокации, либо введите координаты вручную. "},o={text:"Неправильные координаты",discrition:'Введите свои координаты еще раз, либо дайте разрешение на использование геолокации! Пример правильных координат - "53.234, 123.5654"'};function n(e,t){let s=null;s=null==e&&null==t?'<h4 class="location__header">Ваше место расположение неопределено!</h4>':`<h4 class="location__header">Ваше место расположение</h4>\n                  <span class="location__title">[${e}, ${t}]</span>`;const i=`\n                    <div class="location">\n                      <div class="location__user">${s}</div>\n                    </div>\n    `;document.querySelector(".section__lists__files").insertAdjacentHTML("beforeend",i)}class a{constructor(){this.latitude=void 0,this.longitude=void 0,this.formInputValue=null,this.popupTitle=document.querySelector(".popup__title"),this.popupDiscrition=document.querySelector(".popup__discription"),this.popupBtns=document.querySelector(".popup__btns"),this.geolocationPopup=document.querySelector(".geolocation__popup"),this.popupInput=this.geolocationPopup.querySelector(".popup__input")}locate(){navigator.geolocation&&navigator.geolocation.getCurrentPosition((e=>{this.latitude=e.coords.latitude,this.longitude=e.coords.longitude,this.geo=!0,n(this.latitude,this.longitude)}),(e=>{this.geolocationPopup.classList.contains("d__none")&&this.geolocationPopup.classList.remove("d__none"),this.popupBtns.addEventListener("click",(e=>this.onClick(e))),console.log(e)}))}onClick(e){e.preventDefault(),console.log(this.popupInput),this.formInputValue=this.popupInput.value.trim();const t=this.popupInput.value,s=/^\[?-?([1-8]?\d(\.\d{1,18})?|90(\.\d{1,18})?),\s?-?((?:1[0-7]|[1-9])?\d(?:\.\d{1,18})?|180(?:\.0{1,18})?)\]?$/.test(t);e.target.classList.contains("btn__ok")&&""!==this.formInputValue&&this.checkOk(s),e.target.classList.contains("btn__cansel")&&(this.geolocationPopup.classList.add("d__none"),n(this.latitude,this.longitude),this.popupTitle.textContent=i.text,this.popupDiscrition.textContent=i.discrition),this.popupInput.value=""}getCoords(e){const t=e.replace(/^\[/,"").replace(/\]$/,"").split(",");this.latitude=t[0],this.longitude=t[1]}checkOk(e){e?(this.getCoords(this.popupInput.value),this.geolocationPopup.classList.add("d__none"),this.formInputValue&&(n(this.latitude,this.longitude),this.latitude=null,this.longitude=null,this.popupTitle.textContent=i.text,this.popupDiscrition.textContent=i.discrition,this.geolocationPopup.classList.contains("d__none")||this.geolocationPopup.classList.add("d__none"))):(this.popupTitle.textContent=o.text,this.popupDiscrition.textContent=o.discrition)}}const r=performance.now()+108e4;function c(){const e=setInterval((()=>{const t=performance.now()/9,s=Math.round((r-t)/1e3),i=Math.floor(s/60),o=Math.floor(s-3600*i/60),n=new Notification("Сегодня 31.08.2019 - «Последний день лета»",{tag:"lesons",body:` осталось ${i} : ${o} минут `,requireInteraction:!0});if(t>r)return clearInterval(e),void n.close();n.addEventListener("click",(()=>{console.log("click"),n.close(),window.location.href="https://yandex.ru/images"}))}),6e4)}(new class{constructor(){this.request=new e("https://ahj-diplom-back-th6d.onrender.com/new-user"),this.popup=document.querySelector(".popup"),this.loginForm=document.querySelector(".login__form"),this.popupForm=this.loginForm.querySelector(".popup__form"),this.inputTitle=this.loginForm.querySelector(".input__title"),this.container=document.querySelector(".container"),this.listUsers=document.querySelector(".list__users"),this.emojiContainer=document.querySelector(".emoji__container"),this.filesBox=document.querySelector(".files__box"),this.chatConteiner=document.querySelector(".chat__conteiner"),this.formChat=this.chatConteiner.querySelector(".form"),this.checkText=new t,this.chat=document.querySelector(".chat"),this.fileInputAll=this.filesBox.querySelectorAll(".overlapped"),this.videoTimer=document.querySelector(".video__timer"),this.audioTimer=document.querySelector(".audio__timer"),this.videoRecording=document.querySelector(".video__recording"),this.id=null,this.userName=null,this.link=null,this.typesms=null,this.countmessages=0,this.oldElem=null,this.message={},this.oldfirstChild=null,this.duration=0,this.file=null,this.text=null,this.url=null,this.videoRecord=this.chatConteiner.querySelector(".video__record"),this.audioRecording=document.querySelector(".audio__recording"),this.audioRecord=this.audioRecording.querySelector(".audio__record"),this.emoji=this.emojiContainer.querySelectorAll(".emoji"),this.inputFormChat=this.formChat.querySelector(".form__chat__input"),this.clickLink=!1}init(){this.emoji.forEach((e=>{e.addEventListener("click",(e=>this.addSmile(e)))})),this.inputFormChat.addEventListener("keypress",(e=>{"Enter"===e.key&&this.onSubmit(e)})),this.locationDefine=new a,this.popupForm.addEventListener("submit",(e=>this.onSubmit(e))),this.container.addEventListener("click",(e=>this.onClick(e))),this.inputTitle.addEventListener("input",(e=>this.onChange(e))),this.chat.addEventListener("scroll",(e=>this.onScroll(e))),this.fileInputAll.forEach((e=>{e.addEventListener("change",(t=>{this.clinMessage(),this.file=e.files&&e.files[0],this.file&&((t.target.closest(".add__files__title")||t.target.closest(".add__photo__title"))&&(this.url=URL.createObjectURL(e.files&&e.files[0]),this.creatMessageObj(this.file,this.text,this.userName,this.id,this.url,this.countmessages,this.link,this.typesms)),this.message&&this.ws.send(JSON.stringify(this.message)))}))})),this.chat.addEventListener("dragover",(e=>{e.preventDefault()})),this.chat.addEventListener("drop",(e=>this.addDrop(e))),window.addEventListener("unload",(()=>{this.ws.send(JSON.stringify({type:"exit",name:this.userName,id:this.id}))}))}addDrop(e){e.preventDefault(),this.clinMessage(),this.countmessages+=1,e.target.closest(".message")||(this.file=e.dataTransfer.files&&e.dataTransfer.files[0],this.file&&(this.url=URL.createObjectURL(e.dataTransfer.files&&e.dataTransfer.files[0]),this.creatMessageObj(this.file,this.text,this.userName,this.id,this.url,this.countmessages,this.link,this.typesms),this.message&&this.ws.send(JSON.stringify(this.message))))}addSmile(e){const t=e.target.textContent,s=this.inputFormChat.textContent.trim();this.inputFormChat.textContent=`${s}  ${t}`,console.log(this.inputFormChat.textContent)}clinMessage(){this.message={},this.file=null,this.text="",this.link=null,this.url=null,this.typesms=null}creatMessageObj(e,t,s,i,o,n,a,r){this.message.name=s,this.message.dataId=n,this.message.url=o,this.message.id=i,this.message.typesms=r,null!==e?(this.message.fileName=e.name,this.message.fileSize=e.size,e.type.includes("image")&&(this.message.typesms="image"),e.type.includes("video")&&(this.message.typesms="video"),e.type.includes("audio")&&(this.message.typesms="audio"),e.type.includes("application/vnd.openxmlformats-officedocument.wordprocessingml.document")&&(this.message.typesms="file")):this.message.text=t,null!==a&&(this.message.link=a),this.message.type="send",this.message.datatime=(new Date).toLocaleTimeString([],{timeStyle:"short"})}displayImageContent(e){document.querySelectorAll(".preview__image").src=e.target.result}onScroll(e){this.clinMessage();const t=e.target.children,[s]=e.target.children,i=this.chat.getBoundingClientRect().top,o=t[0].getBoundingClientRect();let n=!1;if(n=o.bottom>i&&this.oldElem<o.bottom&&null!==this.oldElem,null==this.oldElem&&(this.oldElem=o.bottom),n){if(this.oldfirstChild=s,this.message.dataId=t[0].getAttribute("data-id"),this.message.name=this.userName,this.message.type="sendAll",!this.message)return;this.ws.send(JSON.stringify(this.message)),n=!1}}onSubmit(e){if(e.preventDefault(),this.clinMessage(),e.target.classList.contains("popup__form")){const e=this.inputTitle.value.trim();e.length>0&&this.request.add({name:e}).then((e=>{const{status:t}=e;"ok"===t&&(this.status=e.status,this.popup.classList.add("d__none"),this.userName=e.user.name,this.id=e.user.id,this.data=e,this.wsActive(),this.container.classList.remove("d__none"),this.locationDefine.locate(),this.locationDefine.latitude&&this.locationDefine.longitude?n(this.locationDefine.latitude,this.locationDefine.longitude):this.popup.classList.contains("d__none")&&this.locationDefine.geo&&this.popup.classList.remove("d__none")),(async()=>{if(window.Notification){if("granted"===Notification.permission)return c(),void console.log("granted no query");if("default"===Notification.permission){const e=await Notification.requestPermission();if(e)return c(),void console.log("granted after query");console.log(e)}}})(),this.cameraListener(),this.microphoneListener(),"error"===t&&this.loginForm.querySelector(".error__name").classList.remove("d__none")}))}if(e.target.closest(".form__chat")){const t=e.target.closest(".form__chat").querySelector(".form__chat__input"),s=t.textContent.trim();this.typesms="text",this.link=this.checkText.checkLink(s);const i=this.checkText.checkCode(s);if(i&&null!==i&&(this.typesms="code"),null!==this.link&&this.link&&(this.typesms="link"),null==i&&null==this.link&&(this.typesms="text"),!s)return;if(this.countmessages+=1,this.text=s,i&&(this.text=s),t.textContent="",this.creatMessageObj(this.file,this.text,this.userName,this.id,this.url,this.countmessages,this.link,this.typesms),!this.message)return;this.ws.send(JSON.stringify(this.message))}}wsActive(){this.ws=new WebSocket("wss://ahj-diplom-back-th6d.onrender.com/"),this.ws.addEventListener("open",(()=>{console.log("ws open")})),this.ws.addEventListener("close",(()=>{console.log("ws close")})),this.ws.addEventListener("message",(e=>{const t=JSON.parse(e.data);1!=this.clickLink?(t instanceof Array&&void 0!==t[0].name&&(this.listUsers.replaceChildren(),t.forEach((e=>{!function(e,t){const s=document.querySelector(".list__users");if(void 0!==e.name){e.name===t&&(e.name="you");const i=`\n              <li class="user connection__user" data-id="${e.id}">\n                  <p class="user__icon"></p>\n                  <p class="user__name">${e.name}</p>\n              </li>\n      `;s.insertAdjacentHTML("beforeend",i)}}(e,this.userName)}))),"allsms"===t.type&&t.message.forEach((e=>{s(e.message,t.type,this.userName)})),"send"===t.type&&s(t,t.type,this.userName),console.log("ws message")):this.clickLink=!1})),this.ws.addEventListener("error",(()=>{console.log("ws error")}))}onClick(e){const t=document.querySelector(".section__lists__files"),s=document.querySelector(".drop-down__menu");if(!e.target.closest(".form__chat__input")){if(e.target.closest(".section__menu")){const s=e.target.closest(".section__header");"list of participants"==s.querySelector(".section__title").textContent?(s.querySelector(".section__title").textContent="Menu",this.listUsers.classList.add("d__none"),t.classList.remove("d__none")):(s.querySelector(".section__title").textContent="list of participants",this.listUsers.classList.remove("d__none"),t.classList.add("d__none"))}e.target.closest(".smile__icon")&&this.clickIcon(this.emojiContainer,this.filesBox),e.target.closest(".clip__icon")&&this.clickIcon(this.filesBox,this.emojiContainer),e.target.closest(".three__dots")&&s.classList.toggle("d__none"),e.target.closest(".btn__close")&&s.classList.add("d__none"),e.target.closest(".video__icon")&&(this.audioRecording.classList.contains("d__none")||this.audioRecording.classList.add("d__none"),this.videoRecording.classList.toggle("d__none")),e.target.closest(".microphone__icon")&&(this.videoRecording.classList.contains("d__none")||this.videoRecording.classList.add("d__none"),this.audioRecording.classList.toggle("d__none")),e.target.closest(".add__files")&&e.target.closest(".add__files").querySelector("input").dispatchEvent(new MouseEvent("click")),e.target.closest(".add__photo__title")&&e.target.closest(".add__photo__title").querySelector("input").dispatchEvent(new MouseEvent("click")),e.target.closest(".message__text")&&(this.clickLink=!0)}}onChange(){this.loginForm.querySelector(".error__name").classList.add("d__none")}clickIcon(e,t){e.classList.toggle("d__none"),t.classList.contains("d__none")||t.classList.add("d__none")}recordListener(e){this.recorder&&"inactive"!==this.recorder.state?(this.recorder.stop(),this.stream.getTracks().forEach((e=>e.stop()))):e.target.classList.contains("video__record")?(this.typesms="video",this.addStream(this.typesms)):(this.typesms="audio",this.addStream(this.typesms))}cameraListener(){this.videoRecord.addEventListener("click",(async e=>this.recordListener(e)))}microphoneListener(){this.audioRecord.addEventListener("click",(e=>this.recordListener(e)))}addTimer(e){this.timer=setInterval((()=>{this.duration+=1;let t=Math.trunc(this.duration/60),s=this.duration-60*t;t<10&&(t=`0${t}`),s<10&&(s=`0${s}`),e.textContent=`${t}:${s}`}),1e3)}async addStream(e){this.clinMessage(),this.stream="video"==e?await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}):await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.recorder=new MediaRecorder(this.stream),this.chunks=[],this.recorder.addEventListener("start",(()=>{"video"==e?this.startRecording(this.videoRecord,e):this.startRecording(this.audioRecord,e)})),this.recorder.addEventListener("dataavailable",(e=>{this.chunks.push(e.data)})),this.recorder.addEventListener("stop",(async()=>{let t;"video"==e?this.stopRecording(this.videoRecording,this.videoRecord,this.videoTimer):this.stopRecording(this.audioRecording,this.audioRecord,this.audioTimer),t="video"==e?new Blob(this.chunks,{type:"video/mp4"}):new Blob(this.chunks,{type:"audio/mp3;"}),this.url=URL.createObjectURL(t),this.file=t,this.countmessages+=1,this.creatMessageObj(this.file,this.text,this.userName,this.id,this.url,this.countmessages,this.link,this.typesms),this.message&&this.ws.send(JSON.stringify(this.message))})),this.recorder.start()}startRecording(e,t){"Запись"==e.textContent&&("video"==t?this.addTimer(this.videoTimer):this.addTimer(this.audioTimer),e.textContent="Остановка")}stopRecording(e,t,s){e.classList.contains("d__none")||e.classList.add("d__none"),"Остановка"==t.textContent&&(t.textContent="Запись",s.textContent="00:00",this.duration=0,clearInterval(this.timer))}}).init()}();